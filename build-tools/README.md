# eng-build-tools
Eng. build tools

Required tools:
Powershell 4+
VS Tools (12.0, 14.0)
OpenCover (https://github.com/OpenCover/opencover)
ReportGenerator (https://github.com/danielpalme/ReportGenerator)
CodeCoverageToHtml (https://subversion.devfactory.com/gfi/faxmaker/Server/trunk/Tools/CodeCoverageToHtml )


Test runner script - testrunner.ps1


This script supports different test runners (mstest, vstest.console, nunit), and coverage tools (vstest.console, OpenCover, DotCover). Script can be extended by adding new modules, so it’s easy to add support for partCover, nCover, gtests and so on.


Script arguments:


LogLevel - controls script output (possible value: Debug, Info, Notice, Warning, Error, default value: Debug)

PathToTests - path to folder with tests binaries


TestRunner - test runner which will be used for running tests (possible values: VSTest, MSTest, NUnit, default value: VSTest). If MS Fakes framework is used then only VSTest must be used. Other runners do not support MS Fakes.


CoverageTool - tools which will be used to collect coverage report (possible values: VS, OpenCover, dotCover, None, default value: VS). If MS Fakes framework is used then only VS and OpenCover tools must be used. Other tools do not support MS Fakes.

CodeBase - reserved argument for future use, currently it is not used.
   
EnableProfiler - reserved argument for future use (would be used to run test with vsperfcmd)

VSInstrExcludeList - reserved argument for future use (exclude list for vsinstr tool)

IncludeFilter - filter tests assemblies, supports ant-style patterns(example:  **/bin/Debug/*Tests.dll,*Test.dll)

ExcludeFilter - exclude tests assemblies, supports ant-style patterns, excluding has priority over including


VSVersion - version of visual studio tools (e.g. 12.0 or 14.0), VS 2015 update 2 has some code coverage issues (https://msdn.microsoft.com/en-US/library/5d9d229c-b97e-47b2-9a60-947477f90211), so it is not recommended to use VS 2015 U2 to get code coverage if MS Fakes framework is used.

OpenCoverFilter - OpenCover assemblies filter assemblies (example: “+[*]* -[*Test*]* -[protobuf-net]*”)


DotCoverFilter - DotCover filter, will be used in /Filters=ARG (example: “-:module=*Specs.dll”)

VSCoverSettings - path to vstest.console settings file (will be used as parameter in /settings: argument)

DotCoverSettings - reserved argument for future use for dotCover settings

VSTestCaseFilter - vstest.console.exe test case filter (example: “Priority!=-1” - all tests with attribute Priority(-1) will be excluded from running)


ReportTool - tool which will be used to build coverage report (possible values: RG, AureaRG). RG - ReportGenerator, AureaRG - internal tool to build and merge reports. Currently RG isn’t supported to be used with DotCover.


NUnitWhereExpression - expression for NUnit filter, e.g. cat==Ci


DonNotPublishReport - coverage report won’t be published in TC, can be used if need to run test runner several times in one job, and then to build combined coverage report


DotCoverSettingsTempFile - temp file name, which will be used to store dotCover settings (default - dotCoverTempSettings.xml)


DotCoverOutput - dotCover output file (default - dotCoverOutput.dcvr)


DotCoverXmlOutput - dotCover xml output file, it’s generated by “dotCover report” command (default - dotCoverOutput.xml)


NUnitOutput - NUnit output file (default NUnitResults.xml)


CoverageZip - output zip-file with coverage report, will be published as artifact


How to use:


OneGuard example: 


./testrunner.ps1 -LogLevel Debug -PathToTests ASSEMBLIES\COMPILED -TestRunner VSTest -CoverageTool OpenCover -CodeBase CS -IncludeFilter *Tests.dll,*Test.dll -VSVersion 12.0 -OpenCoverFilter "+[*]* -[*Test*]* -[protobuf-net]*" -VSCoverSettings "" -VSTestCaseFilter Priority!=-1


Remark: app.config must be modified before running tests (need to remove version and public key from TextListener), otherwise tests wouldn’t be run. 


OneGuard Agent example:


./testrunner.ps1 -LogLevel Debug -PathToTests Source\AgentFramework\Bin\Debug -TestRunner VSTest -CoverageTool VS -CodeBase CS -IncludeFilter "*Tests.dll,*Test.dll" -ExcludeFilter "DeploymentTest*" -VSVersion 12.0 -VSCoverSettings Source\AgentFramework\Src\CodeCoverage.runsettings


Code Coverage:


Script automatically processes tests results, and publish them to TeamCity (for .trx files it uses teamcity import command). ReportGenerator tool is used for building code coverage report (in HtmlSummary mode). Coverage report will be automatically published to TC using publishArtifacts command. If DotCover is selected as coverage tool, then coverage report will be built by TC.


History:


09/26/2016 - added NUnit support, added ant-style support for Include/Exclude filters (alexander.danilov@aurea.com)


09/30/2016 - refactored code to make it more flexible (alexander.danilov@aurea.com)
